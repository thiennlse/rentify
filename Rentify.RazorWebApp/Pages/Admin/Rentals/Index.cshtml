@page
@using Rentify.BusinessObjects.Enum
@model Rentify.RazorWebApp.Pages.Admin.Rentals.IndexModel

@{
    ViewData["Title"] = "Rentals";
}

<h1>Rentals</h1>

<h2>Inquiries</h2>
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="thead-dark">
            <tr>
                <th>User</th>
                <th>Item</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Quantity</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var inquiry in Model.Inquiries)
            {
                <tr>
                    <td>@(inquiry.User?.FullName ?? "Unknown")</td>
                    <td>@(inquiry.Post?.Item?.Name ?? "Unknown")</td>
                    <td>@Html.DisplayFor(modelItem => inquiry.StartDate)</td>
                    <td>@Html.DisplayFor(modelItem => inquiry.EndDate)</td>
                    <td>@inquiry.Quantity</td>
                    <td>
                        <span class="badge @GetInquiryStatusBadgeClass(inquiry.Status)">
                            @Html.DisplayFor(modelItem => inquiry.Status)
                        </span>
                    </td>
                    <td>
                        @if (inquiry.Status == InquiryStatus.Open)
                        {
                            <form asp-page-handler="ApproveInquiry" method="post" class="d-inline">
                                <input type="hidden" name="inquiryId" value="@inquiry.Id" />
                                <button type="submit" class="btn btn-sm btn-primary">Approve</button>
                            </form>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<h2>Rentals</h2>
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="thead-dark">
            <tr>
                <th>User</th>
                <th>Rental Date</th>
                <th>Return Date</th>
                <th>Total Amount</th>
                <th>Status</th>
                <th>Payment Status</th>
                <th>Items</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.Rental)
            {
                <tr>
                    <td>@(item.User?.FullName ?? "Unknown")</td>
                    <td>@Html.DisplayFor(modelItem => item.RentalDate)</td>
                    <td>@Html.DisplayFor(modelItem => item.ReturnDate)</td>
                    <td>@Html.DisplayFor(modelItem => item.TotalAmount)</td>
                    <td>
                        <span class="badge @GetStatusBadgeClass(item.Status)">
                            @Html.DisplayFor(modelItem => item.Status)
                        </span>
                    </td>
                    <td>
                        <span class="badge @GetPaymentStatusBadgeClass(item.PaymentStatus)">
                            @Html.DisplayFor(modelItem => item.PaymentStatus)
                        </span>
                    </td>
                    <td>
                        <a class="btn btn-sm btn-secondary" data-bs-toggle="collapse" href="#items-@item.Id" role="button" aria-expanded="false" aria-controls="items-@item.Id">
                            Xem Items (@item.RentalItems.Count)
                        </a>
                        <div class="collapse" id="items-@item.Id">
                            <ul class="list-group list-group-flush">
                                @foreach (var ri in item.RentalItems)
                                {
                                    <li class="list-group-item">
                                        Item: @ri.Item?.Name | Quantity: @ri.Quantity | Price: @ri.Price
                                    </li>
                                }
                            </ul>
                        </div>
                    </td>
                    <td>
                        <a asp-page="./Edit" asp-route-id="@item.Id" class="btn btn-sm btn-warning">Edit</a>
                        <a asp-page="./Details" asp-route-id="@item.Id" class="btn btn-sm btn-info">Details</a>
                        @if (item.Status == RentalStatus.Quoted)
                        {
                            <form asp-page-handler="Confirm" method="post" class="d-inline">
                                <input type="hidden" name="id" value="@item.Id" />
                                <button type="submit" class="btn btn-sm btn-primary">Confirm</button>
                            </form>
                        }
                        @if (item.Status == RentalStatus.Confirmed)
                        {
                            <form asp-page-handler="Activate" method="post" class="d-inline">
                                <input type="hidden" name="id" value="@item.Id" />
                                <button type="submit" class="btn btn-sm btn-success">Activate</button>
                            </form>
                        }
                        @if (item.Status == RentalStatus.Active)
                        {
                            <form asp-page-handler="Complete" method="post" class="d-inline">
                                <input type="hidden" name="id" value="@item.Id" />
                                <button type="submit" class="btn btn-sm btn-primary">Complete</button>
                            </form>
                        }
                        @if (item.Status != RentalStatus.Completed && item.Status != RentalStatus.Cancelled)
                        {
                            <form asp-page-handler="Cancel" method="post" class="d-inline">
                                <input type="hidden" name="id" value="@item.Id" />
                                <button type="submit" class="btn btn-sm btn-danger">Cancel</button>
                            </form>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (TempData["ErrorMessage"] != null)
{
    <script>
        alert("@TempData["ErrorMessage"]");
    </script>
}

@functions {
    string GetStatusBadgeClass(RentalStatus status)
    {
        return status switch
        {
            RentalStatus.Quoted => "bg-info",
            RentalStatus.Confirmed => "bg-warning",
            RentalStatus.Active => "bg-success",
            RentalStatus.Completed => "bg-primary",
            RentalStatus.Cancelled => "bg-danger",
            RentalStatus.PendingRequest => "bg-secondary",
            _ => "bg-secondary"
        };
    }

    string GetPaymentStatusBadgeClass(PaymentStatus status)
    {
        return status switch
        {
            PaymentStatus.Paid => "bg-success",
            PaymentStatus.Pending => "bg-warning",
            PaymentStatus.Failed => "bg-danger",
            PaymentStatus.Refunded => "bg-info",
            _ => "bg-secondary"
        };
    }

    string GetInquiryStatusBadgeClass(InquiryStatus status)
    {
        return status switch
        {
            InquiryStatus.Open => "bg-warning",
            InquiryStatus.Quoted => "bg-info",
            InquiryStatus.ClosedAccepted => "bg-success",
            InquiryStatus.ClosedRejected => "bg-danger",
            _ => "bg-secondary"
        };
    }
}